{% extends "base.html" %}

{% block title %}Socios{% endblock %}

{% block content %}

<div>
    <h2>Gestión de Socios</h2>
    
    <div>
        <form action="{{ url_for('socios.listar') }}" method="GET">
            <input type="text" name="busqueda" placeholder="Buscar por nombre o email..." value="{{ request.args.get('busqueda', '') }}">
            <button type="submit">Buscar</button>
            
            
            <a href="{{ url_for('socios.listar', solo_prestamos='1') }}">Ver solo con préstamos</a>

            {% if request.args.get('busqueda') or request.args.get('solo_prestamos') %}
                <a href="{{ url_for('socios.listar') }}" style="color: red;">Limpiar filtros</a>
            {% endif %}
        </form>

        <br>

        {% if current_user.is_authenticated %}
            <a href="{{ url_for('socios.crear') }}">
                + Nuevo Socio
            </a>
        {% endif %}
    </div>
</div>

<hr>

{% if request.args.get('solo_prestamos') %}
    <p><em>Mostrando solo socios con libros pendientes de devolución.</em></p>
{% endif %}

<div>
    <table border="1" cellpadding="10" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Estado de Préstamo</th>
                <th>Gestión</th>
            </tr>
        </thead>
        <tbody>
            {% for socio in socios %}
            <tr>
                <td>{{ socio.id }}</td>
                <td>{{ socio.nombre }}</td>
                <td>{{ socio.email }}</td>
                
                <td>
                    {% if socio.libro_prestado %}
                        <strong>Libro actual:</strong> {{ socio.libro_prestado.titulo }}
                    {% else %}
                        <em>Sin libros pendientes</em>
                    {% endif %}
                </td>

                <td>
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('socios.editar', id=socio.id) }}">Editar</a>
                        

                        {% if not socio.libro_prestado %}
                            <form action="{{ url_for('socios.eliminar', id=socio.id) }}" method="POST" style="display:inline;">
                                <button type="submit" onclick="return confirm('¿Eliminar a este socio?');">Borrar</button>
                            </form>
                        {% else %}
                            <span>(No se puede borrar - tiene libros)</span>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" align="center">
                    No hay socios que coincidan con la búsqueda o el filtro.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}